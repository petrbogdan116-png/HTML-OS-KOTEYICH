<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Моя HTML OS</title>
    <style>
        /* Твой оригинальный CSS без изменений — вставь весь CSS из предыдущего кода сюда, чтобы не дублировать */
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; transition: background-color 1s; }
        #install-screen { width: 100vw; height: 100vh; background: linear-gradient(to bottom, #0f0f23, #1a1a2e); display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; z-index: 1001; flex-direction: column; }
        #install-button { background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; font-size: 20px; border: none; cursor: pointer; border-radius: 25px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #install-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        #install-text { font-size: 24px; margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        #boot-screen { width: 100vw; height: 100vh; background: linear-gradient(to bottom, #000, #333); display: none; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; z-index: 1000; }
        #boot-button { background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; padding: 15px 30px; font-size: 20px; border: none; cursor: pointer; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #boot-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        #loading-screen { width: 100vw; height: 100vh; background: linear-gradient(to bottom, #000, #333); display: none; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; z-index: 999; flex-direction: column; }
        #loading-progress { width: 300px; height: 20px; background-color: #333; margin-top: 50px; border-radius: 10px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        #loading-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #00c6ff, #0072ff); transition: width 3s ease-in-out; border-radius: 10px; position: relative; }
        #loading-bar::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shine 1.5s infinite; }
        @keyframes shine { 0% { left: -100%; } 100% { left: 100%; } }
        #loading-text { margin-top: 10px; font-size: 18px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        #desktop { width: 100vw; height: 100vh; position: relative; background: linear-gradient(to bottom, #1e3c72, #2a5298); display: none; transition: background 1s; }
        .icon { position: absolute; cursor: pointer; text-align: center; width: 80px; transition: transform 0.2s; }
        .icon:hover { transform: scale(1.1); }
        .icon img { width: 48px; height: 48px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .icon span { display: block; font-size: 12px; color: white; text-shadow: 1px 1px 2px black; margin-top: 5px; }
        #taskbar { position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; background: rgba(26, 26, 26, 0.95); display: flex; align-items: center; padding: 0 10px; box-shadow: 0 -2px 20px rgba(0,0,0,0.5); backdrop-filter: blur(10px); overflow-x: auto; }
        #taskbar-apps { display: flex; gap: 5px; margin-left: 10px; flex: 1; }
        .taskbar-app { background: rgba(255,255,255,0.1); color: white; padding: 5px 10px; border: none; cursor: pointer; border-radius: 5px; font-size: 12px; white-space: nowrap; transition: background 0.2s; }
        .taskbar-app:hover { background: rgba(255,255,255,0.2); }
        #start-button { background: linear-gradient(45deg, #00d4ff, #0099cc); color: white; padding: 8px 15px; border: none; cursor: pointer; border-radius: 20px; margin-right: 10px; font-weight: bold; }
        #internet-button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; margin-left: auto; padding: 5px; border-radius: 50%; transition: background 0.2s; }
        #internet-button:hover { background: rgba(255,255,255,0.1); }
        #clock { font-size: 14px; font-weight: bold; margin-left: 10px; }
        #balance { font-size: 14px; font-weight: bold; margin-left: 10px; color: #ffd700; }
        #start-menu { position: fixed; bottom: 50px; left: 10px; background: rgba(255,255,255,0.95); color: black; padding: 15px; display: none; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); backdrop-filter: blur(10px); }
        #start-menu button { display: block; width: 100%; padding: 10px; margin: 5px 0; cursor: pointer; border: none; border-radius: 5px; background: #f0f0f0; transition: background 0.2s; }
        #start-menu button:hover { background: #e0e0e0; }
        .window { position: absolute; background: rgba(255,255,255,0.95); color: black; border: 1px solid #ccc; box-shadow: 0 4px 20px rgba(0,0,0,0.3); min-width: 300px; min-height: 200px; display: none; flex-direction: column; border-radius: 10px; overflow: hidden; }
        .window-header { background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; cursor: move; display: flex; justify-content: space-between; align-items: center; }
        .window-controls { display: flex; gap: 5px; }
        .window-minimize, .window-maximize, .window-close { background: none; border: none; color: white; font-weight: bold; cursor: pointer; padding: 0 8px; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s; }
        .window-minimize:hover, .window-maximize:hover, .window-close:hover { background: rgba(255,255,255,0.2); }
        .window-content { padding: 15px; flex-grow: 1; overflow: auto; }
        #browser-content { display: flex; flex-direction: column; }
        #browser-address-bar { display: flex; margin-bottom: 10px; }
        #browser-address { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px 0 0 5px; }
        #home-button { padding: 10px; border: 1px solid #ddd; border-radius: 0 5px 5px 0; background: #f0f0f0; cursor: pointer; }
        #home-button:hover { background: #e0e0e0; }
        #browser-page { flex-grow: 1; background-color: #f9f9f9; padding: 15px; border-radius: 5px; overflow: auto; }
        .download-button { background: linear-gradient(45deg, #4CAF50 0%, #45a049 100%); color: white; padding: 10px 15px; border: none; cursor: pointer; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .download-button:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .buy-button { background: linear-gradient(45deg, #ff9800 0%, #f57c00 100%); color: white; padding: 10px 15px; border: none; cursor: pointer; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .buy-button:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .virus-button { background: linear-gradient(45deg, #f44336 0%, #d32f2f 100%); color: white; padding: 10px 15px; border: none; cursor: pointer; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .virus-button:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #antivirus-icon, #minecraft-icon, #calculator-icon { display: none; top: 20px; left: 120px; }
        #minecraft-icon { left: 320px; }
        #calculator-icon { top: 20px; left: 520px; }
        #googlepay-icon { top: 20px; left: 720px; display: block; }
        #virus-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(45deg, #ff0000, #cc0000); color: white; padding: 20px; display: none; z-index: 1000; text-align: center; border-radius: 10px; box-shadow: 0 4px 20px rgba(255,0,0,0.5); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.05); } 100% { transform: translate(-50%, -50%) scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .infected { animation: shake 0.5s infinite; }
        #bsod { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #0000a0; color: white; display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 2000; font-family: 'Courier New', monospace; text-align: center; padding: 20px; }
        #bsod h1 { font-size: 48px; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        #bsod p { font-size: 18px; margin-bottom: 40px; line-height: 1.5; }
        #bsod button { background: #00ff00; color: black; padding: 10px 20px; font-size: 16px; border: none; cursor: pointer; border-radius: 5px; font-weight: bold; }
        #rsod { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #ff0000; color: white; display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 2000; font-family: 'Courier New', monospace; text-align: center; padding: 20px; }
        #rsod h1 { font-size: 48px; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        #rsod p { font-size: 18px; margin-bottom: 40px; line-height: 1.5; }
        #cmd-window { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: black; color: #00ff00; display: none; justify-content: flex-start; align-items: flex-start; flex-direction: column; z-index: 2001; font-family: 'Courier New', monospace; padding: 20px; overflow-y: auto; }
        #cmd-output { flex-grow: 1; white-space: pre-wrap; font-size: 16px; }
        #cmd-input { background: black; color: #00ff00; border: none; font-family: 'Courier New', monospace; font-size: 16px; width: 100%; outline: none; }
        #restore-dots { font-size: 24px; color: #00ff00; margin-top: 20px; display: none; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.5; } }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; transition: background 0.2s; }
        .file-item:hover { background: #f0f0f0; }
        .file-name { flex-grow: 1; }
        .file-size { font-size: 12px; color: #666; }
        .file-delete { background: #ff4444; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-size: 12px; margin-left: 5px; }
        .file-delete:hover { background: #cc0000; }
        .file-rename { background: #2196F3; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-size: 12px; margin-left: 5px; }
        .file-rename:hover { background: #1976D2; }
        .file-restore { background: #4CAF50; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; font-weight: bold; margin-top: 10px; }
        .file-restore:hover { background: #45a049; }
        .disk-info { background: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-weight: bold; }
        #disk-d-info { display: none; }
        #calculator-window { width: 300px; height: 400px; }
        #calculator-display { width: 100%; height: 60px; font-size: 24px; text-align: right; padding: 0 10px; border: none; background: #f0f0f0; margin-bottom: 10px; }
        .calc-button { width: 70px; height: 60px; font-size: 18px; border: none; background: #e0e0e0; cursor: pointer; border-radius: 5px; margin: 2px; }
        .calc-button:hover { background: #d0d0d0; }
        .calc-operator { background: #ff9500; color: white; }
        .calc-operator:hover { background: #e68900; }
        #messenger-window { width: 500px; height: 600px; }
        #messenger-login, #messenger-chat { display: none; }
        #messenger-register { display: block; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .form-button { background: #4CAF50; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px; }
        .form-button:hover { background: #45a049; }
        #chat-messages { height: 300px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; background: white; margin-bottom: 10px; border-radius: 4px; }
        .message { margin-bottom: 5px; padding: 5px; background: #f0f0f0; border-radius: 4px; }
        #chat-input { width: 80%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        #send-button { width: 18%; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #notebook-window { background: black; color: #00ff00; font-family: 'Courier New', monospace; }
        #notebook-window .window-header { background: #333; }
        #notebook-window .window-content { padding: 20px; text-align: center; font-size: 18px; line-height: 1.5; }
        #minecraft-window { width: 620px; height: 420px; }
        #minecraft-container { width: 100%; height: 100%; image-rendering: pixelated; }
        .network-option { display: flex; align-items: center; margin: 10px 0; }
        .network-option input[type="password"] { margin-left: 10px; padding: 5px; border: 1px solid #ddd; border-radius: 3px; }
        #peer-status { color: #666; font-size: 12px; margin-top: 5px; }
        .download-progress { width: 300px; height: 20px; background-color: #333; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .download-progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #00c6ff, #0072ff); transition: width linear; border-radius: 10px; }
        #antivirus-scan-progress { display: none; margin: 10px 0; }
        #antivirus-virus-list { margin-top: 10px; }
        .virus-item { background: #ffdddd; padding: 5px; margin: 5px 0; border-radius: 3px; border-left: 4px solid #ff0000; }
        #context-menu { position: fixed; background: rgba(255,255,255,0.95); color: black; padding: 10px; display: none; border-radius: 5px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1002; }
        #context-menu button { display: block; width: 100%; padding: 8px; margin: 2px 0; border: none; background: #f0f0f0; cursor: pointer; border-radius: 3px; }
        #context-menu button:hover { background: #e0e0e0; }
        #confirmation-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: black; padding: 20px; display: none; z-index: 1003; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); text-align: center; }
        #confirmation-dialog button { margin: 10px; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        #yes-btn { background: #ff4444; color: white; }
        #no-btn { background: #4CAF50; color: white; }
        #login-screen { width: 100vw; height: 100vh; background: linear-gradient(to bottom, #0f0f23, #1a1a2e); display: none; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; z-index: 1002; flex-direction: column; color: white; }
        #login-screen h2 { margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        #login-screen input { width: 300px; padding: 10px; margin: 10px 0; border: none; border-radius: 5px; font-size: 16px; }
        #login-screen button { background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }
        #login-screen button:hover { transform: translateY(-2px); }
        #os-register, #os-login { text-align: center; }
        #googlepay-window { width: 400px; height: 350px; top: 100px; left: 400px; }
        #request-message { font-size: 16px; font-weight: bold; margin-bottom: 15px; text-align: center; color: #333; }
        #request-sum { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; font-size: 16px; }
        #request-textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; margin-bottom: 10px; font-family: inherit; }
        #send-request-btn { background: linear-gradient(45deg, #4285f4, #34a853); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; }
        #send-request-btn:hover { background: linear-gradient(45deg, #3367d6, #2d8e3e); }
        #request-status { margin-top: 10px; text-align: center; color: #666; }
        #admin-section { margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px; display: none; }
        #admin-section input { width: 100px; margin-right: 5px; }
        #admin-section button { padding: 5px 10px; background: #ff9800; color: white; border: none; border-radius: 3px; cursor: pointer; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/PointerLockControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/shaders/PixelShader.js"></script>
</head>
<body>
    <!-- Весь HTML body из предыдущего кода — вставь полностью: login-screen, install-screen, boot-screen, loading-screen, bsod, rsod, cmd-window, confirmation-dialog, desktop с иконками, taskbar, start-menu, context-menu, все окна (internet, files, browser, antivirus, calculator, minecraft, messenger, notebook, googlepay), virus-alert -->
    <div id="login-screen">
        <h2>Вход в OS</h2>
        <div id="os-register">
            <input type="text" id="reg-username-os" placeholder="Имя пользователя">
            <input type="password" id="reg-password-os" placeholder="Пароль">
            <button onclick="registerOSUser()">Зарегистрироваться</button>
            <p>Уже есть аккаунт? <button onclick="showOSLogin()">Войти</button></p>
        </div>
        <div id="os-login" style="display: none;">
            <input type="text" id="login-username-os" placeholder="Имя пользователя">
            <input type="password" id="login-password-os" placeholder="Пароль">
            <button onclick="loginOSUser()">Войти</button>
            <p>Нет аккаунта? <button onclick="showOSRegister()">Зарегистрироваться</button></p>
        </div>
    </div>

    <div id="install-screen">
        <div id="install-text">Добро пожаловать в установку OS!</div>
        <button id="install-button">Установить OS</button>
    </div>

    <div id="boot-screen">
        <button id="boot-button">ЗАПУСК PC</button>
    </div>

    <div id="loading-screen">
        <div id="loading-progress">
            <div id="loading-bar"></div>
        </div>
        <div id="loading-text">Загрузка...</div>
    </div>

    <div id="bsod">
        <h1>*** STOP: 0x0000007B (0xF78D2524, 0xC0000034, 0x00000000, 0x00000000)</h1>
        <p>INACCESSIBLE_BOOT_DEVICE<br><br>Техническая информация:<br>*** STOP: 0x0000007B INACCESSIBLE_BOOT_DEVICE<br><br>Ядро системы повреждено. Система не может загрузиться.<br>Нажмите кнопку для восстановления.</p>
        <button onclick="startSystemRestore()">Восстановить систему</button>
    </div>

    <div id="rsod">
        <h1>*** STOP: RED SCREEN OF DEATH ***</h1>
        <p>CRITICAL ERROR: HIBERNATION/PAGEFILE CORRUPTED<br><br>Нажмите ПРОБЕЛ для открытия командной строки восстановления.</p>
    </div>

    <div id="cmd-window">
        <div id="cmd-output">C:\Recovery> </div>
        <input type="text" id="cmd-input" autofocus onkeydown="handleCmd(event)">
        <div id="restore-dots"></div>
    </div>

    <div id="confirmation-dialog">
        <p>Вы точно хотите это сделать?!</p>
        <button id="yes-btn" onclick="confirmDelete()">Да</button>
        <button id="no-btn" onclick="cancelDelete()">Нет</button>
    </div>

    <div id="desktop">
        <div class="icon" id="files-icon" style="top: 20px; left: 20px;" ondblclick="openWindow('files')">
            <img src="https://img.icons8.com/color/48/folder.png" alt="Files">
            <span>Файлы</span>
        </div>
        <div class="icon" id="browser-icon" style="top: 20px; left: 220px;" ondblclick="openWindow('browser')">
            <img src="https://img.icons8.com/color/48/internet-browser.png" alt="Browser">
            <span>Браузер</span>
        </div>
        <div class="icon" id="antivirus-icon" ondblclick="openWindow('antivirus')">
            <img src="https://img.icons8.com/color/48/antivirus.png" alt="Antivirus">
            <span>Антивирус</span>
        </div>
        <div class="icon" id="minecraft-icon" ondblclick="openWindow('minecraft')">
            <img src="https://preview.redd.it/kb9w9c28o2871.jpg?auto=webp&s=f2b847c154a28736eda1b034135fc374af3723d8" alt="Minecraft">
            <span>Minecraft 3D</span>
        </div>
        <div class="icon" id="calculator-icon" ondblclick="openWindow('calculator')">
            <img src="https://img.icons8.com/color/48/calculator.png" alt="Calculator">
            <span>Калькулятор</span>
        </div>
        <div class="icon" id="googlepay-icon" ondblclick="openWindow('googlepay')">
            <img src="https://img.icons8.com/color/48/google-wallet.png" alt="Google Pay">
            <span>Google Pay</span>
        </div>
    </div>

    <div id="taskbar">
        <button id="start-button">Start</button>
        <div id="taskbar-apps"></div>
        <button id="internet-button" onclick="openWindow('internet')">🌐</button>
        <div id="clock"></div>
        <div id="balance">Баланс: $<span id="balance-value">0</span></div>
    </div>

    <div id="start-menu">
        <button onclick="shutdown()">Выключить</button>
        <button onclick="restart()">Перезагрузить</button>
        <button onclick="logoutOS()">Выйти из аккаунта</button>
    </div>

    <div id="context-menu">
        <button onclick="createNewFile()">Новый файл</button>
        <button onclick="createNewFolder()">Новая папка</button>
        <button onclick="openDesktopSettings()">Настройки рабочего стола</button>
    </div>

    <!-- Все окна: internet-window, files-window, browser-window, antivirus-window, calculator-window, minecraft-window, messenger-window, notebook-window, googlepay-window — вставь их HTML из оригинала -->
    <div class="window" id="internet-window" style="top: 100px; left: 200px; width: 400px;">
        <div class="window-header">
            <span>Подключение к сети</span>
            <div class="window-controls">
                <button class="window-minimize" onclick="minimizeWindow('internet')">-</button>
                <button class="window-maximize" onclick="toggleMaximizeWindow('internet')">□</button>
                <span class="window-close" onclick="closeWindow('internet')">X</span>
            </div>
        </div>
        <div class="window-content">
            <h3>Доступные сети:</h3>
            <div class="network-option">
                <input type="radio" name="router" value="bad">
                <label>Плохой роутер</label>
                <button onclick="connectToRouter('bad')">Подключить</button>
            </div>
            <div class="network-option">
                <input type="radio" name="router" value="good">
                <label>Хороший роутер</label>
                <input type="password" id="password" placeholder="Пароль">
                <button onclick="connectToRouter('good')">Подключить</button>
            </div>
        </div>
    </div>

    <div class="window" id="files-window" style="top: 100px; left: 100px;">
        <div class="window-header">
            <span>Файлы</span>
            <div class="window-controls">
                <button class="window-minimize" onclick="minimizeWindow('files')">-</button>
                <button class="window-maximize" onclick="toggleMaximizeWindow('files')">□</button>
                <span class="window-close" onclick="closeWindow('files')">X</span>
            </div>
        </div>
        <div class="window-content">
            <div id="disk-c-info" class="disk-info">Диск C: 100 ГБ (свободно: <span id="free-space-c">100</span> ГБ)</div>
            <div id="disk-d-info" class="disk-info">Диск D: 200 ГБ (свободно: <span id="free-space-d">200</span> ГБ)</div>
            <div id="files-list"></div>
            <button class="file-restore" onclick="restoreAllFiles()" id="restore-btn" style="display: none;">Восстановить все системные файлы</button>
        </div>
    </div>

    <div class="window" id="browser-window" style="top: 50px; left: 200px; width: 600px; height: 400px;">
        <div class="window-header">
            <span>Браузер</span>
            <div class="window-controls">
                <button class="window-minimize" onclick="minimizeWindow('browser')">-</button>
                <button class="window-maximize" onclick="toggleMaximizeWindow('browser')">□</button>
                <span class="window-close" onclick="closeWindow('browser')">X</span>
            </div>
        </div>
        <div class="window-content" id="browser-content">
            <div id="browser-address-bar">
                <input type="text" id="browser-address" placeholder="Введите адрес..." onkeydown="if(event.keyCode==13) loadPage(this.value)">
                <button id="home-button" onclick="loadHome()">Главная</button>
            </div>
            <div id="browser-page">
                <p>Добро пожаловать в браузер! Введите адрес, например: antivirus.com, rockstargames.com, minecraft.net, budka.nett, compshop.cat, calculator.com, freegames.ru, news.com, messenger.com</p>
            </div>
        </div>
    </div>

    <div class="window" id="antivirus-window" style="top: 150px; left: 300px;">
        <div class="window-header">
            <span>Антивирус</span>
            <div class="window-controls">
                <button class="window-minimize" onclick="minimizeWindow('antivirus')">-</button>
                <button class="window-maximize" onclick="toggleMaximizeWindow('antivirus')">□</button>
                <span class="window-close" onclick="closeWindow('antivirus')">X</span>
            </div>
        </div>
        <div class="window-content">
            <p>Считыватель вирусов: Сканирование системы...</p>
            <div id="antivirus-scan-progress">
                <div class="download-progress">
                    <div class="download-progress-bar" id="scan-progress-bar"></div>
                </div>
                <p id="scan-text">Сканирование...</p>
            </div>
            <div id="antivirus-virus-list"></div>
            <button onclick="scanForVirus()">Сканировать и удалить вирусы</button>
        </div>
    </div>

    <div class="window" id="calculator-window" style="top: 50px; left: 50px;">
        <div class="window-header">
            <span>Калькулятор</span>
            <div class="window-controls">
                <button class="window-minimize" onclick="minimizeWindow('calculator')">-</button>
                <button class="window-maximize" onclick="toggleMaximizeWindow('calculator')">□</button>
                <span class="window-close" onclick="closeWindow('calculator')">X</span>
            </div>
        </div>
        <div class="window-content">
            <input type="text" id="calculator-display" readonly>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;">
                <button class="calc-button" onclick="appendToCalc('7')">7</button>
                <button class="calc-button" onclick="appendToCalc('8')">8</button>
                <button class="calc-button" onclick="appendToCalc('9')">9</button>
                <button class="calc-button calc-operator" onclick="appendToCalc('/')">/</button>
                <button class="calc-button" onclick="appendToCalc('4')">4</button>
                <button class="calc-button" onclick="appendToCalc('5')">5</button>
                <button class="calc-button" onclick="appendToCalc('6')">6</button>
                <button class="calc-button calc-operator" onclick="appendToCalc('*')">*</button>
                <button class="calc-button" onclick="appendToCalc('1')">1</button>
                <button class="calc-button" onclick="appendToCalc('2')">2</button>
                <button class="calc-button" onclick="appendToCalc('3')">3</button>
                <button class="calc-button calc-operator" onclick="appendToCalc('-')">-</button>
                <button class="calc-button" onclick="appendToCalc('0')">0</button>
                <button class="calc-button" onclick="appendToCalc('.')">.</button>
                <button class="calc-button" onclick="calculate()">=</button>
                <button class="calc-button calc-operator" onclick="appendToCalc('+')">+</button>
                <button class="calc-button" onclick="clearCalc()" style="grid-column: span 4;">C</button>
            </div>
        </div>
    </div>

    <div class="window" id="minecraft-window" style="top: 50px; left: 50px;">
        <div class="window-header">
            <span>Minecraft 3D</span>
            <div class="window-controls">
                <button class="window-minimize" onclick="minimizeWindow('minecraft')">-</button>
                <button class="window-maximize" onclick="toggleMaximizeWindow('minecraft')">□</button>
                <span class="window-close" onclick="closeWindow('minecraft')">X</span>
            </div>
        </div>
        <div class="window-content" style="padding: 0;">
            <div id="minecraft-container"></div>
        </div>
    </div>

    <div class="window" id="messenger-window" style="top: 100px; left: 100px;">
        <div class="window-header">
            <span>Мессенджер</span>
            <div class="window-controls">
                <button class="window-minimize" onclick="minimizeWindow('messenger')">-</button>
                <button class="window-maximize" onclick="toggleMaximizeWindow('messenger')">□</button>
                <span class="window-close" onclick="closeWindow('messenger')">X</span>
            </div>
        </div>
        <div class="window-content">
            <div id="messenger-register">
                <h3>Регистрация</h3>
                <div class="form-group">
                    <label>Имя пользователя:</label>
                    <input type="text" id="reg-username">
                </div>
                <div class="form-group">
                    <label>Пароль:</label>
                    <input type="password" id="reg-password">
                </div>
                <div class="form-group">
                    <label>Кастомный номер (ID для чата):</label>
                    <input type="text" id="reg-number" placeholder="Например, mycoolid123">
                </div>
                <button class="form-button" onclick="registerUser()">Зарегистрироваться</button>
                <p>Уже есть аккаунт? <button onclick="showLogin()">Войти</button></p>
                <div id="peer-status"></div>
            </div>
            <div id="messenger-login">
                <h3>Вход</h3>
                <div class="form-group">
                    <label>Имя пользователя:</label>
                    <input type="text" id="login-username">
                </div>
                <div class="form-group">
                    <label>Пароль:</label>
                    <input type="password" id="login-password">
                </div>
                <button class="form-button" onclick="loginUser()">Войти</button>
                <p>Нет аккаунта? <button onclick="showRegister()">Зарегистрироваться</button></p>
            </div>
            <div id="messenger-chat" style="display: none;">
                <h3>Чат</h3>
                <p>Ваш логин: <span id="user-id"></span></p>
                <div id="chat-messages"></div>
                <input type="text" id="chat-input" placeholder="Сообщение..." onkeydown="if(event.keyCode==13) sendMessage()">
                <button id="send-button" onclick="sendMessage()">Отправить</button>
                <button class="form-button" onclick="logout()">Выйти</button>
            </div>
        </div>
    </div>

    <div class="window" id="notebook-window" style="top: 100px; left: 100px; width: 500px; height: 300px;">
        <div class="window-header">
            <span>Супер Артёмский блокнот</span>
            <div class="window-controls">
                <button class="window-minimize" onclick="minimizeWindow('notebook')">-</button>
                <button class="window-maximize" onclick="toggleMaximizeWindow('notebook')">□</button>
                <span class="window-close" onclick="closeWindow('notebook')">X</span>
            </div>
        </div>
        <div class="window-content" id="notebook-content">
            <p>Это обычный текстовый файл, тролль!</p>
        </div>
    </div>

    <div class="window" id="googlepay-window">
        <div class="window-header">
            <span>Google Pay</span>
            <div class="window-controls">
                <button class="window-minimize" onclick="minimizeWindow('googlepay')">-</button>
                <button class="window-maximize" onclick="toggleMaximizeWindow('googlepay')">□</button>
                <span class="window-close" onclick="closeWindow('googlepay')">X</span>
            </div>
        </div>
        <div class="window-content">
            <p id="request-message">Попроси Админа Дать Тебе денег!</p>
            <input type="number" id="request-sum" placeholder="Сумма ($)" min="1" max="1000">
            <textarea id="request-textarea" placeholder="Напиши сообщение админу..."></textarea>
            <button id="send-request-btn" onclick="sendMoneyRequest()">Отправить запрос</button>
            <p id="request-status"></p>
            <div id="admin-section">
                <h4>Админ-панель (только для admin):</h4>
                <input type="text" id="admin-user" placeholder="Пользователь">
                <input type="number" id="admin-amount" placeholder="Сумма ($)" min="1">
                <button onclick="approveRequest()">Одобрить запрос</button>
                <p>Или вручную добавь 'approved: true' и 'sum: X' в Firebase для авто-обновления.</p>
            </div>
        </div>
    </div>

    <div id="virus-alert">
        <p>ВИРУС! Система заражена!</p>
        <button onclick="document.getElementById('virus-alert').style.display = 'none';">OK</button>
    </div>

    <script>
        // Firebase config — ЗАМЕНИ НА РЕАЛЬНЫЙ!
        const firebaseConfig = {
            apiKey: "AIzaSyD...example", // Твой реальный из Console
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com/",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // UPDATED: Separate localStorage for OS and Messenger
        function getOSUsers() {
            const usersStr = localStorage.getItem('osUsers') || '{}';
            return JSON.parse(usersStr);
        }
        function saveOSUsers(users) {
            localStorage.setItem('osUsers', JSON.stringify(users));
        }
        function getMessengerUsers() {
            const usersStr = localStorage.getItem('messengerUsers') || '{}';
            return JSON.parse(usersStr);
        }
        function saveMessengerUsers(users) {
            localStorage.setItem('messengerUsers', JSON.stringify(users));
        }
        function getMessages() {
            const msgsStr = localStorage.getItem('chatMessages') || '[]';
            return JSON.parse(msgsStr);
        }
        function saveMessages(messages) {
            localStorage.setItem('chatMessages', JSON.stringify(messages));
        }

        // Глобальные переменные
        let currentOSUser = null; // Для OS
        let currentChatUser = null; // Для чата
        let isInfected = false;
        let minecraftInstalled = false;
        let connection = 'none';
        const maximizedWindows = new Set();
        let minimizedWindows = new Set();
        let taskbarButtons = new Map();
        let freeSpaceC = 100;
        let freeSpaceD = 200;
        let hasDiskD = false;
        let balance = 0;
        let ultraWifi = false;
        let files = [];
        let virusInterval;
        let calcDisplay = '';
        let rsodTriggeredFiles = [];
        let restoreInterval;
        let pendingDeleteFile = null;
        let scanning = false;
        let moneyRequestsListener = null;

        // NEW: Listener для moneyRequests
        function setupMoneyRequestsListener() {
            if (moneyRequestsListener) database.ref('moneyRequests').off('child_added', moneyRequestsListener);
            moneyRequestsListener = (snapshot) => {
                const request = snapshot.val();
                if (request && request.user === currentOSUser?.username && request.approved === true) {
                    const sum = request.sum || 0;
                    if (sum > 0) {
                        balance += sum;
                        updateBalance();
                        saveOSUserData();
                        alert(`Админ одобрил! +$${sum} на баланс. Новый баланс: $${balance}`);
                        snapshot.ref.remove();
                    }
                }
            };
            database.ref('moneyRequests').on('child_added', moneyRequestsListener);
        }

        // OS Functions (with debug)
        function showOSRegister() {
            document.getElementById('os-register').style.display = 'block';
            document.getElementById('os-login').style.display = 'none';
        }
        function showOSLogin() {
            document.getElementById('os-register').style.display = 'none';
            document.getElementById('os-login').style.display = 'block';
        }

        function registerOSUser() {
            const username = document.getElementById('reg-username-os').value.trim();
            const password = document.getElementById('reg-password-os').value;
            console.log('OS Register attempt:', username, password); // DEBUG
            if (username && password) {
                const users = getOSUsers();
                if (users[username]) {
                    console.log('OS User exists:', username); // DEBUG
                    alert('Пользователь уже существует!');
                } else {
                    const defaultFiles = [
                        { name: 'system32.dll', desc: 'Основной системный файл', size: '5 МБ', deleted: false },
                        { name: 'boot.ini', desc: 'Конфигурация загрузки', size: '1 КБ', deleted: false },
                        { name: 'kernel.sys', desc: 'Ядро ОС', size: '10 МБ', deleted: false },
                        { name: 'user.config', desc: 'Настройки пользователя', size: '2 КБ', deleted: false },
                        { name: 'desktop.ini', desc: 'Настройки десктопа', size: '1 КБ', deleted: false },
                        { name: 'ntoskrnl.exe', desc: 'Загрузчик ядра', size: '8 МБ', deleted: false },
                        { name: 'winlogon.exe', desc: 'Процесс входа в систему', size: '3 МБ', deleted: false },
                        { name: 'explorer.exe', desc: 'Оболочка проводника', size: '4 МБ', deleted: false },
                        { name: 'svchost.exe', desc: 'Хост служб', size: '2 МБ', deleted: false },
                        { name: 'csrss.exe', desc: 'Клиент/сервер подсистемы', size: '1 МБ', deleted: false },
                        { name: 'lsass.exe', desc: 'Локальная безопасность', size: '2 МБ', deleted: false },
                        { name: 'registry.dat', desc: 'Реестр системы', size: '50 МБ', deleted: false },
                        { name: 'pagefile.sys', desc: 'Файл подкачки', size: '2 ГБ', deleted: false },
                        { name: 'hiberfil.sys', desc: 'Файл гибернации', size: '1 ГБ', deleted: false }
                    ];
                    users[username] = {
                        password: password,
                        balance: 0,
                        hasDiskD: false,
                        ultraWifi: false,
                        isInfected: false,
                        installedApps: { antivirus: false, minecraft: false, calculator: false },
                        files: defaultFiles
                    };
                    saveOSUsers(users);
                    console.log('OS Registered:', username, users[username]); // DEBUG
                    alert('Регистрация успешна! Теперь войдите.');
                    showOSLogin();
                }
            } else {
                console.log('OS Register fail: empty fields'); // DEBUG
                alert('Заполните все поля!');
            }
        }

        function loginOSUser() {
            const username = document.getElementById('login-username-os').value.trim();
            const password = document.getElementById('login-password-os').value;
            console.log('OS Login attempt:', username, password); // DEBUG
            if (username && password) {
                const users = getOSUsers();
                console.log('OS Users loaded:', Object.keys(users)); // DEBUG
                if (users[username] && users[username].password === password) {
                    currentOSUser = { username: username };
                    const userData = users[username];
                    balance = userData.balance || 0;
                    hasDiskD = userData.hasDiskD || false;
                    ultraWifi = userData.ultraWifi || false;
                    isInfected = userData.isInfected || false;
                    freeSpaceC = 100;
                    freeSpaceD = hasDiskD ? 200 : 0;
                    files = userData.files || [];
                    const installed = userData.installedApps || {};
                    minecraftInstalled = installed.minecraft || false;
                    document.getElementById('antivirus-icon').style.display = installed.antivirus ? 'block' : 'none';
                    document.getElementById('minecraft-icon').style.display = minecraftInstalled ? 'block' : 'none';
                    document.getElementById('calculator-icon').style.display = installed.calculator ? 'block' : 'none';
                    if (hasDiskD) document.getElementById('disk-d-info').style.display = 'block';
                    updateFreeSpaceC();
                    updateFreeSpaceD();
                    updateBalance();
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('desktop').style.display = 'block';
                    document.getElementById('taskbar').style.display = 'flex';
                    renderFilesList();
                    if (isInfected) setTimeout(showVirusAlert, 1000);
                    setupMoneyRequestsListener();
                    document.getElementById('admin-section').style.display = username === 'admin' ? 'block' : 'none';
                    console.log('OS Login success:', username); // DEBUG
                    alert('Добро пожаловать, ' + username + '!');
                } else {
                    console.log('OS Login fail: no user or wrong pass'); // DEBUG
                    alert('Неверный логин или пароль!');
                }
            } else {
                console.log('OS Login fail: empty fields'); // DEBUG
                alert('Заполните все поля!');
            }
        }

        function saveOSUserData() {
            if (!currentOSUser) return;
            const users = getOSUsers();
            users[currentOSUser.username] = {
                ...users[currentOSUser.username],
                balance,
                hasDiskD,
                ultraWifi,
                isInfected,
                files,
                installedApps: {
                    antivirus: document.getElementById('antivirus-icon').style.display !== 'none',
                    minecraft: minecraftInstalled,
                    calculator: document.getElementById('calculator-icon').style.display !== 'none'
                }
            };
            saveOSUsers(users);
        }

        function logoutOS() {
            if (moneyRequestsListener) {
                database.ref('moneyRequests').off('child_added', moneyRequestsListener);
                moneyRequestsListener = null;
            }
            currentOSUser = null;
            document.getElementById('start-menu').style.display = 'none';
            shutdown();
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'flex';
                showOSLogin();
            }, 1000);
        }

        // Messenger Functions (separate storage, with debug)
        function showRegister() {
            document.getElementById('messenger-register').style.display = 'block';
            document.getElementById('messenger-login').style.display = 'none';
            document.getElementById('messenger-chat').style.display = 'none';
        }
        function showLogin() {
            document.getElementById('messenger-register').style.display = 'none';
            document.getElementById('messenger-login').style.display = 'block';
            document.getElementById('messenger-chat').style.display = 'none';
        }
        function registerUser() {
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value;
            const number = document.getElementById('reg-number').value.trim();
            console.log('Chat Register attempt:', username, password, number); // DEBUG
            if (username && password && number) {
                const users = getMessengerUsers();
                if (users[username]) {
                    console.log('Chat User exists:', username); // DEBUG
                    alert('Пользователь с таким именем уже существует!');
                } else {
                    users[username] = { password, id: number };
                    saveMessengerUsers(users);
                    console.log('Chat Registered:', username, users[username]); // DEBUG
                    alert('Регистрация успешна! Ваш ID: ' + number);
                    showLogin();
                }
            } else {
                console.log('Chat Register fail: empty fields'); // DEBUG
                alert('Заполните все поля!');
            }
        }
        function loginUser() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            console.log('Chat Login attempt:', username, password); // DEBUG
            if (username && password) {
                const users = getMessengerUsers();
                console.log('Chat Users loaded:', Object.keys(users)); // DEBUG
                if (users[username] && users[username].password === password) {
                    currentChatUser = { username, id: users[username].id || 'default' };
                    showChat();
                    console.log('Chat Login success:', username); // DEBUG
                } else {
                    console.log('Chat Login fail: no user or wrong pass'); // DEBUG
                    alert('Неверный пароль!');
                }
            } else {
                console.log('Chat Login fail: empty fields'); // DEBUG
                alert('Заполните все поля!');
            }
        }
        function logout() {
            currentChatUser = null;
            document.getElementById('chat-messages').innerHTML = '';
            showRegister();
        }
        function showChat() {
            if (!currentChatUser) {
                alert('Сначала войдите!');
                return;
            }
            document.getElementById('messenger-register').style.display = 'none';
            document.getElementById('messenger-login').style.display = 'none';
            document.getElementById('messenger-chat').style.display = 'block';
            document.getElementById('user-id').innerText = currentChatUser.username;
            loadMessages();
        }
        function loadMessages() {
            const messages = getMessages();
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.innerHTML = '';
            messages.forEach(msg => addMessage(msg.from + ': ' + msg.message));
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        function sendMessage() {
            const messageInput = document.getElementById('chat-input');
            const message = messageInput.value.trim();
            if (message && currentChatUser) {
                const messages = getMessages();
                messages.push({
                    from: currentChatUser.username,
                    message: message,
                    timestamp: Date.now()
                });
                saveMessages(messages);
                messageInput.value = '';
                loadMessages();
            }
        }
        function addMessage(msg) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerText = msg;
            messagesDiv.appendChild(messageDiv);
        }

        // Остальные функции (updateBalance, showLoadingAdvanced, updateClock, openWindow, closeWindow, etc.) — вставь из оригинального кода полностью
        function updateBalance() {
            document.getElementById('balance-value').innerText = balance;
        }

        function showLoadingAdvanced(text, stages, callback, duration = 3000) {
            document.getElementById('loading-screen').style.display = 'flex';
            document.getElementById('loading-text').innerText = text;
            document.getElementById('loading-bar').style.transition = `width ${duration / 1000}s ease-in-out`;
            document.getElementById('loading-bar').style.width = '0%';
            let stageIndex = 0;
            const stageInterval = setInterval(() => {
                if (stageIndex < stages.length) {
                    document.getElementById('loading-text').innerText = stages[stageIndex];
                    stageIndex++;
                }
            }, duration / stages.length);
            setTimeout(() => {
                document.getElementById('loading-bar').style.width = '100%';
            }, 100);
            setTimeout(() => {
                clearInterval(stageInterval);
                document.getElementById('loading-screen').style.display = 'none';
                callback();
            }, duration);
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString();
        }
        setInterval(updateClock, 1000);
        updateClock();

        document.getElementById('start-button').onclick = function() {
            const menu = document.getElementById('start-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        };

        function shutdown() {
            document.getElementById('start-menu').style.display = 'none';
            document.getElementById('desktop').style.display = 'none';
            document.getElementById('taskbar').style.display = 'none';
            document.querySelectorAll('.window').forEach(w => w.style.display = 'none');
            clearTaskbar();
        }

        function restart() {
            document.getElementById('start-menu').style.display = 'none';
            shutdown();
            setTimeout(() => {
                document.getElementById('boot-button').onclick();
            }, 1000);
        }

        function openWindow(id) {
            const window = document.getElementById(id + '-window');
            window.style.display = 'flex';
            if (minimizedWindows.has(id)) {
                minimizedWindows.delete(id);
                updateTaskbar(id, false);
            }
            if (maximizedWindows.has(id)) {
                toggleMaximizeWindow(id);
            }
            if (id === 'files') {
                renderFilesList();
            }
            if (id === 'calculator') {
                document.getElementById('calculator-display').value = '0';
            }
            if (id === 'messenger') {
                showRegister();
            }
            if (id === 'minecraft' && minecraftInstalled) {
                initMinecraft();
            }
            if (id === 'antivirus') {
                document.querySelector('#antivirus-window p').innerText = 'Считыватель вирусов: Система чиста.';
                document.getElementById('antivirus-virus-list').innerHTML = '';
            }
            if (id === 'googlepay') {
                document.getElementById('request-sum').value = '';
                document.getElementById('request-textarea').value = '';
                document.getElementById('request-status').innerText = '';
                document.getElementById('admin-section').style.display = currentOSUser && currentOSUser.username === 'admin' ? 'block' : 'none';
            }
            if (isInfected) {
                setTimeout(showVirusAlert, 1000);
            }
        }

        function closeWindow(id) {
            const window = document.getElementById(id + '-window');
            window.style.display = 'none';
            maximizedWindows.delete(id);
            minimizedWindows.delete(id);
            updateTaskbar(id, false);
        }

        function minimizeWindow(id) {
            const window = document.getElementById(id + '-window');
            window.style.display = 'none';
            if (!minimizedWindows.has(id)) {
                minimizedWindows.add(id);
                updateTaskbar(id, true);
            }
        }

        function updateTaskbar(id, isMinimized) {
            const taskbarApps = document.getElementById('taskbar-apps');
            if (isMinimized) {
                if (!taskbarButtons.has(id)) {
                    const btn = document.createElement('button');
                    btn.className = 'taskbar-app';
                    btn.innerText = id.charAt(0).toUpperCase() + id.slice(1);
                    btn.onclick = () => openWindow(id);
                    taskbarApps.appendChild(btn);
                    taskbarButtons.set(id, btn);
                }
            } else {
                if (taskbarButtons.has(id)) {
                    const btn = taskbarButtons.get(id);
                    btn.remove();
                    taskbarButtons.delete(id);
                }
            }
        }

        function clearTaskbar() {
            minimizedWindows.clear();
            taskbarButtons.forEach((btn) => btn.remove());
            taskbarButtons.clear();
        }

        function toggleMaximizeWindow(id) {
            const window = document.getElementById(id + '-window');
            const btn = document.querySelector(`#${id}-window .window-maximize`);
            if (maximizedWindows.has(id)) {
                window.style.width = '';
                window.style.height = '';
                window.style.top = '';
                window.style.left = '';
                window.style.position = 'absolute';
                maximizedWindows.delete(id);
                btn.innerText = '□';
            } else {
                window.style.width = '100vw';
                window.style.height = 'calc(100vh - 50px)';
                window.style.top = '0';
                window.style.left = '0';
                maximizedWindows.add(id);
                btn.innerText = '❐';
            }
        }

        function connectToRouter(type) {
            if (type === 'bad') {
                connection = 'bad';
                alert('Подключено к Плохому роутеру. Загрузки будут медленнее.');
            } else if (type === 'good') {
                const pass = document.getElementById('password').value;
                if (pass === '656124') {
                    connection = 'good';
                    alert('Подключено к Хорошему роутеру. Загрузки будут быстрее.');
                } else {
                    alert('Неверный пароль!');
                    return;
                }
            }
            closeWindow('internet');
        }

        function getDownloadDelay() {
            if (ultraWifi) return 2000;
            if (connection === 'none') {
                alert('Нет подключения к интернету! Подключитесь через кнопку 🌐 в панели задач.');
                return null;
            }
            return connection === 'bad' ? 5000 : 2000;
        }

        function getPageDelay() {
            if (ultraWifi) return 1000;
            if (connection === 'none') {
                alert('Нет подключения к интернету! Подключитесь через кнопку 🌐 в панели задач.');
                return null;
            }
            return connection === 'bad' ? 5000 : 2000;
        }

        function checkSpace(sizeGB, disk) {
            let freeSpace = disk === 'D' ? freeSpaceD : freeSpaceC;
            let maxSpace = disk === 'D' ? 200 : 100;
            if (sizeGB > freeSpace) {
                alert(`Недостаточно места на ${disk}! Требуется ${sizeGB} ГБ, доступно ${freeSpace} ГБ из ${maxSpace} ГБ.`);
                return false;
            }
            if (disk === 'D') {
                freeSpaceD -= sizeGB;
                updateFreeSpaceD();
            } else {
                freeSpaceC -= sizeGB;
                updateFreeSpaceC();
            }
            return true;
        }

        function updateFreeSpaceC() {
            document.getElementById('free-space-c').innerText = freeSpaceC.toFixed(2);
        }

        function updateFreeSpaceD() {
            document.getElementById('free-space-d').innerText = freeSpaceD.toFixed(2);
        }

        function buyDiskD() {
            if (balance < 100) {
                alert('Недостаточно средств! Баланс: $' + balance);
                return;
            }
            balance -= 100;
            hasDiskD = true;
            freeSpaceD = 200;
            document.getElementById('disk-d-info').style.display = 'block';
            updateBalance();
            updateFreeSpaceD();
            saveOSUserData();
            alert('Диск D на 200 ГБ куплен и установлен!');
        }

        function buyUltraWifi() {
            if (balance < 20) {
                alert('Недостаточно средств! Баланс: $' + balance);
                return;
            }
            balance -= 20;
            ultraWifi = true;
            updateBalance();
            saveOSUserData();
            alert('ULTRAWIFI куплен! Теперь загрузки за 2с, открытие страниц за 1с.');
        }

        function renderFilesList() {
            const list = document.getElementById('files-list');
            list.innerHTML = '<h3>Системные файлы (Диск C):</h3>';
            let hasDeleted = false;
            files.forEach(file => {
                if (!file.deleted) {
                    const item = document.createElement('div');
                    item.className = 'file-item';
                    item.innerHTML = `
                        <span class="file-name">${file.name} - ${file.desc}</span>
                        <span class="file-size">(${file.size})</span>
                        <button class="file-rename" onclick="renameFile('${file.name}')">Переименовать</button>
                        <button class="file-delete" onclick="promptDelete('${file.name}')">Удалить</button>
                    `;
                    list.appendChild(item);
                } else {
                    hasDeleted = true;
                }
            });
            const restoreBtn = document.getElementById('restore-btn');
            restoreBtn.style.display = hasDeleted ? 'block' : 'none';
        }

        function renameFile(oldName) {
            const newName = prompt('Новое имя файла:', oldName);
            if (newName && newName !== oldName && newName.trim()) {
                const file = files.find(f => f.name === oldName);
                if (file) {
                    file.name = newName.trim();
                    renderFilesList();
                    saveOSUserData();
                    alert('Файл переименован.');
                }
            }
        }

        function promptDelete(name) {
            pendingDeleteFile = name;
            document.getElementById('confirmation-dialog').style.display = 'block';
        }

        function confirmDelete() {
            document.getElementById('confirmation-dialog').style.display = 'none';
            if (pendingDeleteFile) {
                deleteFile(pendingDeleteFile);
                pendingDeleteFile = null;
            }
        }

        function cancelDelete() {
            document.getElementById('confirmation-dialog').style.display = 'none';
            pendingDeleteFile = null;
        }

        function deleteFile(name) {
            const file = files.find(f => f.name === name);
            if (file) {
                file.deleted = true;
                saveOSUserData();
                if (name === 'kernel.sys') {
                    document.body.style.backgroundColor = 'white';
                    document.body.style.color = 'black';
                    setTimeout(() => {
                        showBSOD();
                    }, 3000);
                } else if (name === 'hiberfil.sys' || name === 'pagefile.sys') {
                    rsodTriggeredFiles.push(name);
                    showRSOD();
                } else if (name === 'ntoskrnl.exe' || name === 'registry.dat') {
                    showBSOD();
                } else {
                    alert('Файл удалён.');
                    renderFilesList();
                }
            }
        }

        function showBSOD() {
            document.body.style.backgroundColor = '';
            document.body.style.color = '';
            document.getElementById('bsod').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            document.getElementById('desktop').style.display = 'none';
            document.getElementById('taskbar').style.display = 'none';
            document.querySelectorAll('.window').forEach(w => w.style.display = 'none');
            clearTaskbar();
        }

        function showRSOD() {
            document.getElementById('rsod').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            document.getElementById('desktop').style.display = 'none';
            document.getElementById('taskbar').style.display = 'none';
            document.querySelectorAll('.window').forEach(w => w.style.display = 'none');
            clearTaskbar();
            document.addEventListener('keydown', handleSpaceKey);
        }

        function handleSpaceKey(event) {
            if (event.key === ' ') {
                document.getElementById('rsod').style.display = 'none';
                document.getElementById('cmd-window').style.display = 'flex';
                document.getElementById('cmd-input').focus();
                document.removeEventListener('keydown', handleSpaceKey);
            }
        }

        function handleCmd(event) {
            if (event.key === 'Enter') {
                const input = document.getElementById('cmd-input');
                const command = input.value.trim();
                const output = document.getElementById('cmd-output');
                output.textContent += command + '\n';
                input.value = '';
                if (command === 'SYS.REBOOT.BSD') {
                    startRestoration();
                } else {
                    output.textContent += 'Неизвестная команда. Используйте SYS.REBOOT.BSD для восстановления.\n';
                }
                output.textContent += 'C:\Recovery> ';
                output.scrollTop = output.scrollHeight;
            }
        }

        function startRestoration() {
            const output = document.getElementById('cmd-output');
            output.textContent += 'Запуск восстановления...\n';
            document.getElementById('cmd-input').style.display = 'none';
            document.getElementById('restore-dots').style.display = 'block';
            let dots = 0;
            restoreInterval = setInterval(() => {
                const text = 'Восстановление';
                if (dots === 0) {
                    document.getElementById('restore-dots').textContent = text + '.';
                } else if (dots === 1) {
                    document.getElementById('restore-dots').textContent = text + '..';
                } else {
                    document.getElementById('restore-dots').textContent = text + '...';
                    dots = -1;
                }
                dots++;
            }, 500);
            setTimeout(() => {
                clearInterval(restoreInterval);
                rsodTriggeredFiles.forEach(fileName => {
                    const file = files.find(f => f.name === fileName);
                    if (file) file.deleted = false;
                });
                rsodTriggeredFiles = [];
                document.getElementById('cmd-window').style.display = 'none';
                document.getElementById('restore-dots').style.display = 'none';
                showLoadingAdvanced('ВОССТАНОВЛЕНИЕ ОС', ['Восстановление файлов...', 'Проверка целостности...', 'Перезагрузка...'], function() {
                    document.getElementById('desktop').style.display = 'block';
                    document.getElementById('taskbar').style.display = 'flex';
                }, 2000);
            }, 30000);
        }

        function startSystemRestore() {
            document.getElementById('bsod').style.display = 'none';
            showLoadingAdvanced('ВОССТАНОВЛЕНИЕ ОС', ['Анализ повреждений...', 'Восстановление ядра...', 'Финализация...'], function() {
                restoreSystemAfterLoad();
            }, 10000);
        }

        function restoreSystemAfterLoad() {
            restoreAllFiles(true);
            document.getElementById('desktop').style.display = 'block';
            document.getElementById('taskbar').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function restoreAllFiles(fromBSOD = false) {
            files.forEach(f => f.deleted = false);
            saveOSUserData();
            if (!fromBSOD) {
                alert('Все системные файлы восстановлены.');
                renderFilesList();
            }
        }

        // Перетаскивание окон
        const windows = document.querySelectorAll('.window');
        windows.forEach(win => {
            const header = win.querySelector('.window-header');
            header.onmousedown = function(event) {
                if (event.target.classList.contains('window-minimize') || 
                    event.target.classList.contains('window-maximize') || 
                    event.target.classList.contains('window-close')) {
                    return;
                }
                event.preventDefault();
                let shiftX = event.clientX - win.getBoundingClientRect().left;
                let shiftY = event.clientY - win.getBoundingClientRect().top;
                function moveAt(pageX, pageY) {
                    win.style.left = pageX - shiftX + 'px';
                    win.style.top = pageY - shiftY + 'px';
                }
                function onMouseMove(event) {
                    moveAt(event.pageX, event.pageY);
                }
                document.addEventListener('mousemove', onMouseMove);
                document.onmouseup = function() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.onmouseup = null;
                };
            };
            header.ondragstart = function() {
                return false;
            };
        });

        // Браузер functions
        function loadHome() {
            const addressInput = document.getElementById('browser-address');
            addressInput.value = '';
            const page = document.getElementById('browser-page');
            page.innerHTML = '<p>Добро пожаловать в браузер! Введите адрес, например: antivirus.com, rockstargames.com, minecraft.net, budka.nett, compshop.cat, calculator.com, freegames.ru, news.com, messenger.com</p>';
        }

        function loadPage(address) {
            const page = document.getElementById('browser-page');
            const pageDelay = getPageDelay();
            if (pageDelay === null) return;
            page.innerHTML = '<p>Загрузка...</p>';
            setTimeout(() => {
                address = address.toLowerCase();
                if (!address || address === '') {
                    loadHome();
                    return;
                }
                if (address === 'antivirus.com') {
                    page.innerHTML = '<h3>Antivirus.com</h3><p>Скачайте антивирус! (20 МБ)</p><button class="download-button" onclick="downloadAntivirus()">Скачать</button>';
                } else if (address === 'rockstargames.com') {
                    page.innerHTML = '<h3>RockstarGames</h3><p>Grand Theft Auto VI (Вирус! 15 ГБ)</p><button class="virus-button" onclick="downloadVirus()">Скачать</button>';
                } else if (address === 'minecraft.net') {
                    page.innerHTML = '<h3>Minecraft.net</h3><p>Minecraft 3D (20 ГБ)</p><button class="download-button" onclick="downloadMinecraft()">Скачать</button>';
                } else if (address === 'budka.nett') {
                    page.innerHTML = '<h3>БУДКА.nett</h3><p>Супер Артёмский блокнот (40 ГБ)</p><button class="download-button" onclick="downloadNotebook()">Скачать</button>';
                } else if (address === 'compshop.cat') {
                    page.innerHTML = '<h3>CompShop.cat</h3><p>Купите Диск D на 200 ГБ! (100$)</p><button class="buy-button" onclick="buyDiskD()">Купить</button><p>Купите ULTRAWIFI для супер-скорости! (20$)</p><button class="buy-button" onclick="buyUltraWifi()">Купить</button>';
                } else if (address === 'calculator.com') {
                    page.innerHTML = '<h3>Calculator.com</h3><p>Скачайте калькулятор! (5 МБ)</p><button class="download-button" onclick="downloadCalculator()">Скачать</button>';
                } else if (address === 'freegames.ru') {
                    page.innerHTML = '<h3>FreeGames.ru</h3><p>Бесплатные игры (Вирус! 8 ГБ)</p><button class="virus-button" onclick="downloadVirus()">Скачать игру</button>';
                } else if (address === 'news.com') {
                    page.innerHTML = '<h3>News.com</h3><p>Новости дня (Безопасно, 0 МБ)</p><p>Последние новости: Мир в порядке.</p>';
                } else if (address === 'messenger.com') {
                    page.innerHTML = '<h3>Messenger.com</h3><p>Откройте мессенджер для чата (0 МБ)</p><button class="download-button" onclick="openWindow(\'messenger\')">Открыть</button>';
                } else {
                    page.innerHTML = '<p>Страница не найдена.</p>';
                }
            }, pageDelay);
        }

        function downloadWithDiskChoice(sizeGB, downloadFunc, successMsg, page) {
            const delay = getDownloadDelay();
            if (delay === null) return;
            page.innerHTML += '<div class="download-progress"><div class="download-progress-bar" id="dl-progress"></div></div><p>Скачивание в процессе...</p>';
            const progressBar = document.getElementById('dl-progress');
            progressBar.style.transition = `width ${delay / 1000}s linear`;
            progressBar.style.width = '0%';
            setTimeout(() => {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    if (hasDiskD) {
                        let disk = prompt('На какой диск скачать? (C или D)');
                        if (disk !== 'C' && disk !== 'D') {
                            alert('Неверный выбор. Скачивание отменено.');
                            return;
                        }
                        if (!checkSpace(sizeGB, disk)) return;
                    } else {
                        if (!checkSpace(sizeGB, 'C')) return;
                    }
                    downloadFunc();
                    alert(successMsg);
                    const progressContainer = page.querySelector('.download-progress');
                    if (progressContainer) progressContainer.remove();
                    const p = page.querySelector('p:last-child');
                    if (p && p.innerText.includes('процессе')) p.remove();
                }, 100);
            }, 10);
        }

        function downloadAntivirus() {
            const page = document.getElementById('browser-page');
            downloadWithDiskChoice(0.02, function() {
                document.getElementById('antivirus-icon').style.display = 'block';
                saveOSUserData();
            }, 'Антивирус скачан!', page);
        }

        function downloadVirus() {
            const page = document.getElementById('browser-page');
            const delay = getDownloadDelay();
            if (delay === null) return;
            page.innerHTML += '<div class="download-progress"><div class="download-progress-bar" id="dl-progress"></div></div><p>Скачивание вируса в процессе...</p>';
            const progressBar = document.getElementById('dl-progress');
            progressBar.style.transition = `width ${delay / 1000}s linear`;
            progressBar.style.width = '0%';
            setTimeout(() => {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    isInfected = true;
                    const desktop = document.getElementById('desktop');
                    desktop.style.background = 'linear-gradient(to bottom, #8B0000, #DC143C)';
                    desktop.classList.add('infected');
                    if (virusInterval) clearInterval(virusInterval);
                    virusInterval = setInterval(showVirusAlert, 3000);
                    saveOSUserData();
                    alert('Вирус скачан! Система заражена.');
                    const progressContainer = page.querySelector('.download-progress');
                    if (progressContainer) progressContainer.remove();
                    const p = page.querySelector('p:last-child');
                    if (p && p.innerText.includes('вируса')) p.remove();
                }, 100);
            }, 10);
        }

        function downloadMinecraft() {
            const page = document.getElementById('browser-page');
            downloadWithDiskChoice(20, function() {
                minecraftInstalled = true;
                document.getElementById('minecraft-icon').style.display = 'block';
                saveOSUserData();
            }, 'Minecraft 3D скачан!', page);
        }

        function downloadNotebook() {
            const page = document.getElementById('browser-page');
            downloadWithDiskChoice(40, function() {
                openWindow('notebook');
            }, 'Супер Артёмский блокнот скачан! (Это тролль)', page);
        }

        function downloadCalculator() {
            const page = document.getElementById('browser-page');
            downloadWithDiskChoice(0.005, function() {
                document.getElementById('calculator-icon').style.display = 'block';
                saveOSUserData();
            }, 'Калькулятор скачан!', page);
        }

        function showVirusAlert() {
            document.getElementById('virus-alert').style.display = 'block';
        }

        function scanForVirus() {
            if (scanning) return;
            scanning = true;
            const progressDiv = document.getElementById('antivirus-scan-progress');
            const scanText = document.getElementById('scan-text');
            const virusList = document.getElementById('antivirus-virus-list');
            const progressBar = document.getElementById('scan-progress-bar');
            progressDiv.style.display = 'block';
            virusList.innerHTML = '';
            scanText.innerText = 'Сканирование дисков...';
            progressBar.style.width = '0%';
            progressBar.style.transition = 'width 8s linear';
            setTimeout(() => {
                progressBar.style.width = '100%';
            }, 50);

            let stages = ['Сканирование дисков...', 'Проверка реестра...', 'Анализ памяти...', 'Сканирование сетевых угроз...'];
            let stageIndex = 0;
            const stageInterval = setInterval(() => {
                if (stageIndex < stages.length) {
                    scanText.innerText = stages[stageIndex];
                    stageIndex++;
                }
            }, 2000);

            setTimeout(() => {
                clearInterval(stageInterval);
                if (isInfected) {
                    scanText.innerText = 'Вирусы найдены!';
                    virusList.innerHTML = '<div class="virus-item">Вирус: Trojan.GTA (в RockstarGames.exe)</div><div class="virus-item">Вирус: Malware.Game (в freegames.dll)</div>';
                    setTimeout(() => {
                        isInfected = false;
                        const desktop = document.getElementById('desktop');
                        desktop.style.background = 'linear-gradient(to bottom, #1e3c72, #2a5298)';
                        desktop.classList.remove('infected');
                        if (virusInterval) {
                            clearInterval(virusInterval);
                            virusInterval = null;
                        }
                        scanText.innerText = 'Вирусы удалены!';
                        virusList.innerHTML = '';
                        saveOSUserData();
                        alert('Вирусы удалены!');
                    }, 2000);
                } else {
                    scanText.innerText = 'Система чиста.';
                    alert('Система чиста.');
                }
                scanning = false;
                progressDiv.style.display = 'none';
            }, 8000);
        }

        // Калькулятор
        function appendToCalc(value) {
            calcDisplay += value;
            document.getElementById('calculator-display').value = calcDisplay;
        }
        function clearCalc() {
            calcDisplay = '';
            document.getElementById('calculator-display').value = '0';
        }
        function calculate() {
            try {
                calcDisplay = eval(calcDisplay).toString();
                document.getElementById('calculator-display').value = calcDisplay;
            } catch {
                calcDisplay = 'Ошибка';
                document.getElementById('calculator-display').value = calcDisplay;
            }
        }

        // Контекстное меню
        document.addEventListener('mousedown', function(event) {
            if (event.button === 2) { // Правый клик
                event.preventDefault();
                const contextMenu = document.getElementById('context-menu');
                contextMenu.style.left = event.pageX + 'px';
                contextMenu.style.top = event.pageY + 'px';
                contextMenu.style.display = 'block';
            } else {
                document.getElementById('context-menu').style.display = 'none';
            }
        });

        function createNewFile() {
            const name = prompt('Имя нового файла:');
            if (name) {
                files.push({ name: name, desc: 'Новый файл', size: '0 КБ', deleted: false });
                saveOSUserData();
                alert('Файл создан: ' + name);
                if (document.getElementById('files-window').style.display !== 'none') {
                    renderFilesList();
                }
            }
            document.getElementById('context-menu').style.display = 'none';
        }

        function createNewFolder() {
            const name = prompt('Имя новой папки:');
            if (name) {
                alert('Папка создана: ' + name + ' (функционал папок в разработке)');
            }
            document.getElementById('context-menu').style.display = 'none';
        }

        function openDesktopSettings() {
            alert('Настройки рабочего стола (функционал в разработке)');
            document.getElementById('context-menu').style.display = 'none';
        }

        // Minecraft
        let scene, camera, renderer, controls, composer;
        function initMinecraft() {
            const container = document.getElementById('minecraft-container');
            if (!container) return;
            while (container.firstChild) container.removeChild(container.firstChild);
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, 600 / 400, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(600, 400);
            renderer.setPixelRatio(1);
            container.appendChild(renderer.domElement);
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 5, 5);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x404040));
            const blockSize = 1;
            const geometry = new THREE.BoxGeometry(blockSize, blockSize, blockSize);
            const materialGrass = new THREE.MeshBasicMaterial({ color: 0x228B22 });
            const materialDirt = new THREE.MeshBasicMaterial({ color: 0x8B4513 });
            const blocks = [];
            for (let x = -10; x <= 10; x++) {
                for (let z = -10; z <= 10; z++) {
                    const dirt = new THREE.Mesh(geometry, materialDirt);
                    dirt.position.set(x, -1, z);
                    scene.add(dirt);
                    blocks.push(dirt);
                    const grass = new THREE.Mesh(geometry, materialGrass);
                    grass.position.set(x, 0, z);
                    scene.add(grass);
                    blocks.push(grass);
                }
            }
            controls = new THREE.PointerLockControls(camera, renderer.domElement);
            scene.add(controls.getObject());
            container.addEventListener('click', () => controls.lock());
            const velocity = new THREE.Vector3();
            const direction = new THREE.Vector3();
            const onKeyDown = function (event) {
                switch (event.code) {
                    case 'KeyW': velocity.z = -0.1; break;
                    case 'KeyS': velocity.z = 0.1; break;
                    case 'KeyA': velocity.x = -0.1; break;
                    case 'KeyD': velocity.x = 0.1; break;
                    case 'Space': if (controls.getObject().position.y < 1) velocity.y = 0.2; break;
                }
            };
            const onKeyUp = function (event) {
                switch (event.code) {
                    case 'KeyW': case 'KeyS': velocity.z = 0; break;
                    case 'KeyA': case 'KeyD': velocity.x = 0; break;
                }
            };
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2(0, 0);
            container.addEventListener('mousedown', (event) => {
                mouse.x = (event.clientX / 600) * 2 - 1;
                mouse.y = - (event.clientY / 400) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(blocks);
                if (intersects.length > 0) {
                    const intersect = intersects[0];
                    if (event.button === 0) {
                        scene.remove(intersect.object);
                        blocks.splice(blocks.indexOf(intersect.object), 1);
                    } else if (event.button === 2) {
                        const newBlock = new THREE.Mesh(geometry, materialGrass);
                        newBlock.position.copy(intersect.point.add(intersect.face.normal));
                        scene.add(newBlock);
                        blocks.push(newBlock);
                    }
                }
            });
            composer = new THREE.EffectComposer(renderer);
            const renderPass = new THREE.RenderPass(scene, camera);
            composer.addPass(renderPass);
            const pixelPass = new THREE.ShaderPass(THREE.PixelShader);
            pixelPass.uniforms["resolution"].value = new THREE.Vector2(600, 400);
            pixelPass.uniforms["pixelSize"].value = 4;
            composer.addPass(pixelPass);
            const copyPass = new THREE.ShaderPass(THREE.CopyShader);
            composer.addPass(copyPass);
            camera.position.y = 2;
            function animate() {
                requestAnimationFrame(animate);
                if (controls.isLocked) {
                    direction.z = velocity.z;
                    direction.x = velocity.x;
                    direction.normalize();
                    controls.moveForward(direction.z * 0.1);
                    controls.moveRight(direction.x * 0.1);
                    velocity.y -= 0.01;
                    controls.getObject().position.y += velocity.y;
                    if (controls.getObject().position.y < 1) {
                        velocity.y = 0;
                        controls.getObject().position.y = 1;
                    }
                }
                composer.render();
            }
            animate();
        }

        // Google Pay
        function sendMoneyRequest() {
            if (!currentOSUser) {
                alert('Сначала войдите в систему!');
                return;
            }
            const sum = parseInt(document.getElementById('request-sum').value) || 0;
            const message = document.getElementById('request-textarea').value.trim();
            if (sum <= 0 || !message) {
                alert('Укажите сумму (>0) и сообщение!');
                return;
            }
            const requestData = {
                user: currentOSUser.username,
                sum: sum,
                message: message,
                timestamp: Date.now(),
                balance: balance,
                approved: false
            };
            const requestsRef = database.ref('moneyRequests').push();
            requestsRef.set(requestData).then(() => {
                document.getElementById('request-status').innerText = `Запрос на $${sum} отправлен! Админ увидит в Firebase.`;
                document.getElementById('request-sum').value = '';
                document.getElementById('request-textarea').value = '';
                setTimeout(() => {
                    document.getElementById('request-status').innerText = '';
                }, 5000);
            }).catch((error) => {
                alert('Ошибка отправки: ' + error.message + '. Проверь config и правила БД!');
            });
        }

        function approveRequest() {
            const user = document.getElementById('admin-user').value.trim();
            const amount = parseInt(document.getElementById('admin-amount').value) || 0;
            if (!user || amount <= 0) {
                alert('Укажите пользователя и сумму!');
                return;
            }
            if (currentOSUser.username !== 'admin') {
                alert('Только админ может одобрять!');
                return;
            }
            const users = getOSUsers();
            if (users[user]) {
                users[user].balance += amount;
                saveOSUsers(users);
                if (user === currentOSUser.username) {
                    balance += amount;
                    updateBalance();
                }
                alert(`Одобрено! +$${amount} для ${user}`);
                document.getElementById('admin-user').value = '';
                document.getElementById('admin-amount').value = '';
            } else {
                alert('Пользователь не найден!');
            }
        }

        // Инициализация
        document.getElementById('install-screen').style.display = 'flex';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('boot-screen').style.display = 'none';
        document.getElementById('desktop').style.display = 'none';
        document.getElementById('taskbar').style.display = 'none';
        updateFreeSpaceC();

        // Install & Boot
        document.getElementById('install-button').onclick = function() {
            document.getElementById('install-screen').style.display = 'none';
            showLoadingAdvanced('Установка OS...', ['Инициализация...', 'Копирование файлов...', 'Настройка реестра...', 'Завершение...'], function() {
                document.getElementById('boot-screen').style.display = 'flex';
            }, 5000);
        };

        document.getElementById('boot-button').onclick = function() {
            document.getElementById('boot-screen').style.display = 'none';
            showLoadingAdvanced('Загрузка OS...', ['Загрузка ядра...', 'Инициализация драйверов...', 'Запуск служб...', 'Готово!'], function() {
                document.getElementById('login-screen').style.display = 'flex';
                showOSRegister();
            }, 4000);
        };
    </script>
</body>
</html>
