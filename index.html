<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- Твой оригинальный <head> без изменений -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Моя HTML OS</title>
    <!-- ... весь CSS из оригинала ... -->
</head>
<body>
    <!-- Твой оригинальный body без изменений, но добавляем экран логина/регистрации -->
    <!-- Экран установки OS -->
    <div id="install-screen">
        <div id="install-text">Добро пожаловать в установку OS!</div>
        <button id="install-button">Установить OS</button>
    </div>

    <!-- Экран загрузки (выключенный ПК) -->
    <div id="boot-screen">
        <button id="boot-button">ЗАПУСК PC</button>
    </div>

    <!-- Анимация загрузки -->
    <div id="loading-screen">
        <div id="loading-progress">
            <div id="loading-bar"></div>
        </div>
        <div id="loading-text">Загрузка...</div>
    </div>

    <!-- NEW: Экран логина/регистрации OS -->
    <div id="login-screen" style="width: 100vw; height: 100vh; background: linear-gradient(to bottom, #0f0f23, #1a1a2e); display: none; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; z-index: 1002; flex-direction: column;">
        <h2>Вход в OS</h2>
        <div id="os-register" style="display: block;">
            <input type="text" id="reg-username-os" placeholder="Имя пользователя">
            <input type="password" id="reg-password-os" placeholder="Пароль">
            <button onclick="registerOSUser()">Зарегистрироваться</button>
            <p>Уже есть аккаунт? <button onclick="showOSLogin()">Войти</button></p>
        </div>
        <div id="os-login" style="display: none;">
            <input type="text" id="login-username-os" placeholder="Имя пользователя">
            <input type="password" id="login-password-os" placeholder="Пароль">
            <button onclick="loginOSUser()">Войти</button>
            <p>Нет аккаунта? <button onclick="showOSRegister()">Зарегистрироваться</button></p>
        </div>
    </div>

    <!-- ... все остальные div из оригинала (BSOD, RSOD, cmd-window, desktop, taskbar, etc.) ... -->

    <!-- ... окна (internet-window, files-window, etc.) без изменений ... -->

    <!-- UPDATED: Start-меню с кнопкой выхода -->
    <div id="start-menu">
        <button onclick="shutdown()">Выключить</button>
        <button onclick="restart()">Перезагрузить</button>
        <!-- NEW: -->
        <button onclick="logoutOS()">Выйти из аккаунта</button>
    </div>

    <!-- ... остальной HTML без изменений ... -->

    <script>
        // Firebase Config (без изменений)
        const firebaseConfig = {
          apiKey: "AIzaSyBY2XQifQLL5btjQdveJFNIHDEmMLPqS-A",
          authDomain: "html-os-koteyich.firebaseapp.com",
          projectId: "html-os-koteyich",
          storageBucket: "html-os-koteyich.firebasestorage.app",
          messagingSenderId: "1022444470083",
          appId: "1:1022444470083:web:9d00bc04b79a6da99979f6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // UPDATED: Глобальные переменные (теперь синхронизируются с Firebase)
        let currentUser = null; // NEW: Глобальный для всей OS
        let isInfected = false;
        let minecraftInstalled = false;
        let connection = 'none';
        const maximizedWindows = new Set();
        let minimizedWindows = new Set();
        let taskbarButtons = new Map();
        let freeSpaceC = 100;
        let freeSpaceD = 200;
        let hasDiskD = false;
        let balance = 0;
        let ultraWifi = false;
        let files = []; // NEW: Будет загружаться из Firebase
        let virusInterval;
        let messagesListener = null;
        let calcDisplay = '';
        let rsodTriggeredFiles = [];
        let dotInterval;
        let restoreInterval;
        let pendingDeleteFile = null;
        let scanning = false;

        // NEW: Функции для OS-логина/регистрации
        function showOSRegister() {
            document.getElementById('os-register').style.display = 'block';
            document.getElementById('os-login').style.display = 'none';
        }
        function showOSLogin() {
            document.getElementById('os-register').style.display = 'none';
            document.getElementById('os-login').style.display = 'block';
        }

        function registerOSUser() {
            const username = document.getElementById('reg-username-os').value.trim();
            const password = document.getElementById('reg-password-os').value;
            if (username && password) {
                db.ref('users/' + username).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        alert('Пользователь уже существует!');
                    } else {
                        // NEW: Создаём дефолтные данные для нового пользователя
                        const defaultFiles = [
                            { name: 'system32.dll', desc: 'Основной системный файл', size: '5 МБ', deleted: false },
                            // ... все остальные дефолтные файлы из оригинала
                            { name: 'hiberfil.sys', desc: 'Файл гибернации', size: '1 ГБ', deleted: false }
                        ];
                        db.ref('users/' + username).set({
                            password: password,
                            balance: 0,
                            hasDiskD: false,
                            ultraWifi: false,
                            isInfected: false,
                            installedApps: { antivirus: false, minecraft: false, calculator: false },
                            files: defaultFiles
                        }).then(() => {
                            alert('Регистрация успешна! Теперь войдите.');
                            showOSLogin();
                        }).catch((error) => alert('Ошибка: ' + error.message));
                    }
                });
            } else {
                alert('Заполните поля!');
            }
        }

        function loginOSUser() {
            const username = document.getElementById('login-username-os').value.trim();
            const password = document.getElementById('login-password-os').value;
            if (username && password) {
                db.ref('users/' + username).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        if (userData.password === password) {
                            currentUser = { username: username };
                            // NEW: Загружаем данные пользователя
                            loadUserData(userData);
                            document.getElementById('login-screen').style.display = 'none';
                            // NEW: Открываем десктоп
                            document.getElementById('desktop').style.display = 'block';
                            document.getElementById('taskbar').style.display = 'flex';
                            updateBalance();
                            renderFilesList(); // Обновляем список файлов
                            if (isInfected) setTimeout(showVirusAlert, 1000);
                            alert('Добро пожаловать, ' + username + '!');
                        } else {
                            alert('Неверный пароль!');
                        }
                    } else {
                        alert('Пользователь не найден!');
                    }
                }).catch((error) => alert('Ошибка: ' + error.message));
            } else {
                alert('Заполните поля!');
            }
        }

        // NEW: Загрузка данных пользователя из Firebase
        function loadUserData(userData) {
            balance = userData.balance || 0;
            hasDiskD = userData.hasDiskD || false;
            ultraWifi = userData.ultraWifi || false;
            isInfected = userData.isInfected || false;
            freeSpaceC = 100; // Всегда фиксировано
            freeSpaceD = hasDiskD ? 200 : 0;
            files = userData.files || []; // Массив файлов
            const installed = userData.installedApps || {};
            minecraftInstalled = installed.minecraft || false;
            document.getElementById('antivirus-icon').style.display = installed.antivirus ? 'block' : 'none';
            document.getElementById('minecraft-icon').style.display = minecraftInstalled ? 'block' : 'none';
            document.getElementById('calculator-icon').style.display = installed.calculator ? 'block' : 'none';
            if (hasDiskD) document.getElementById('disk-d-info').style.display = 'block';
            updateFreeSpaceC();
            updateFreeSpaceD();
        }

        // NEW: Сохранение данных в Firebase (вызывается при изменениях)
        function saveUserData() {
            if (!currentUser) return;
            const userRef = db.ref('users/' + currentUser.username);
            userRef.update({
                balance: balance,
                hasDiskD: hasDiskD,
                ultraWifi: ultraWifi,
                isInfected: isInfected,
                files: files,
                installedApps: {
                    antivirus: document.getElementById('antivirus-icon').style.display !== 'none',
                    minecraft: minecraftInstalled,
                    calculator: document.getElementById('calculator-icon').style.display !== 'none'
                }
            }).catch((error) => console.error('Ошибка сохранения:', error));
        }

        // UPDATED: Установка OS (теперь ведёт к экрану логина)
        document.getElementById('install-button').onclick = function() {
            document.getElementById('install-screen').style.display = 'none';
            showLoadingAdvanced('Установка OS...', ['Инициализация...', 'Копирование файлов...', 'Настройка реестра...', 'Завершение...'], function() {
                document.getElementById('boot-screen').style.display = 'flex';
            }, 5000);
        };

        // UPDATED: Запуск OS (теперь к экрану логина)
        document.getElementById('boot-button').onclick = function() {
            document.getElementById('boot-screen').style.display = 'none';
            showLoadingAdvanced('Загрузка OS...', ['Загрузка ядра...', 'Инициализация драйверов...', 'Запуск служб...', 'Готово!'], function() {
                document.getElementById('login-screen').style.display = 'flex'; // NEW: Показываем логин
            }, 4000);
        };

        // ... все остальные функции из оригинала (updateClock, shutdown, etc.) ...

        // UPDATED: Функции, где происходят изменения данных (добавляем saveUserData())
        function buyDiskD() {
            if (balance < 100) {
                alert('Недостаточно средств! Баланс: $' + balance);
                return;
            }
            balance -= 100;
            hasDiskD = true;
            freeSpaceD = 200;
            document.getElementById('disk-d-info').style.display = 'block';
            updateBalance();
            updateFreeSpaceD();
            saveUserData(); // NEW:
            alert('Диск D куплен!');
        }

        function buyUltraWifi() {
            if (balance < 20) {
                alert('Недостаточно средств! Баланс: $' + balance);
                return;
            }
            balance -= 20;
            ultraWifi = true;
            updateBalance();
            saveUserData(); // NEW:
            alert('ULTRAWIFI куплен!');
        }

        // UPDATED: Удаление файла (сохраняем в БД)
        function deleteFile(name) {
            const file = files.find(f => f.name === name);
            if (file) {
                file.deleted = true;
                saveUserData(); // NEW:
                // ... остальной код (BSOD, etc.) без изменений
            }
        }

        // UPDATED: Скачивания (обновляем installedApps)
        function downloadAntivirus() {
            // ... код скачивания ...
            document.getElementById('antivirus-icon').style.display = 'block';
            saveUserData(); // NEW:
        }

        function downloadMinecraft() {
            // ... код ...
            minecraftInstalled = true;
            document.getElementById('minecraft-icon').style.display = 'block';
            saveUserData(); // NEW:
        }

        function downloadCalculator() {
            // ... код ...
            document.getElementById('calculator-icon').style.display = 'block';
            saveUserData(); // NEW:
        }

        // UPDATED: Вирус (обновляем isInfected)
        function downloadVirus() {
            // ... код ...
            isInfected = true;
            saveUserData(); // NEW:
        }

        // UPDATED: Антивирус (очищаем инфекцию)
        function scanForVirus() {
            // ... код сканирования ...
            if (isInfected) {
                // ... удаление ...
                isInfected = false;
                saveUserData(); // NEW:
            }
        }

        // UPDATED: Восстановление файлов
        function restoreAllFiles(fromBSOD = false) {
            files.forEach(f => f.deleted = false);
            saveUserData(); // NEW:
            if (!fromBSOD) {
                alert('Файлы восстановлены.');
                renderFilesList();
            }
        }

        // NEW: Выход из аккаунта
        function logoutOS() {
            if (messagesListener) messagesListener.off();
            currentUser = null;
            document.getElementById('start-menu').style.display = 'none';
            shutdown(); // Закрываем всё
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'flex';
                showOSLogin();
            }, 1000);
        }

        // UPDATED: Мессенджер (использует глобальный currentUser)
        function showChat() {
            if (!currentUser) {
                alert('Сначала войдите в OS!');
                return;
            }
            // ... остальной код ...
            document.getElementById('user-id').innerText = currentUser.username;
            startMessageListener();
        }

        // UPDATED: Рендер файлов (использует глобальный files)
        function renderFilesList() {
            // ... код без изменений, но files из БД ...
        }

        // ... все остальные функции (калькулятор, Minecraft, etc.) без изменений ...

        // Инициализация (без изменений)
        document.getElementById('taskbar').style.display = 'none';
        document.getElementById('boot-screen').style.display = 'none';
        updateFreeSpaceC();
    </script>
</body>
</html>
